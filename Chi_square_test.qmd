---
title: "Chi-squared test"
author: Vladimir Buskin
abstract: > 
  The chi-squared ($\chi^2$) test helps determine if there is a statistically significant association between two categorical variables. It compares the observed frequencies of categories with those expected under the null hypothesis. The $\chi^2$ (chi-squared) score quantifies the difference between observed and expected frequencies for every cell in a contingency table. The greater the difference between observed and expected, the higher the $\chi^2$ score and the lower the $p$-value, given the degrees of freedom. It is recommended to compute effect size measures and inspect the residuals to assess the nature of the association.
format:
  html:
    self-contained: true
    code-fold: false
    theme: default
    toc: true
    toc-depth: 4
    number-sections: true
    slide-number: true
    incremental: false
    slide-level: 3
    scrollable: true
editor: visual
bibliography: R.bib
metadata-files:
  - _quarto.yml
google-scholar: false
---

## Preparation

::: callout-tip
## Script

You can find the full R script associated with this unit
[here](...).
:::


```{r, echo = FALSE, include = FALSE}
library(readxl)
library(tidyverse)
library(confintr)
```


```{r, echo = TRUE, eval = TRUE}
#  Load libraries
library(readxl)
library(tidyverse)
library(confintr) # for effect size calculation

# Load data
cl.order <- read_xlsx("Paquot_Larsson_2020_data.xlsx")

```

## The $\chi^2$-test

Recall our statistical hypotheses stated in the previous unit:

-   $H_0:$ The variables `ORDER` and `SUBORDTYPE` are independent.

-   $H_1:$ The variables `ORDER` and `SUBORDTYPE` are **not**
    independent.

The next step is to compute a test statistic that indicates how strongly our data
conforms to $H_0$. For instance, the Pearson $\chi^2$ statistic is
suitable for categorical data.

It requires two types of values: the **observed frequencies** $n_{ij}$ in our data set and the **expected frequencies** $m_{ij}$, which we would expect to see if $H_0$ were true, with $n, m \in \mathbb{N}$. The indices $i$ and $j$ uniquely identify the frequencies found in
all column-row combinations of a cross-table.

::: {.callout-note collapse="false" title="Mathematical details: The structure of a contingency table"}
The table below represents a generic contingency table where $X$ and $Y$
are categorical variables. Each $x_i$ represents a category of $X$ and
each $y_j$ represents a category of $Y$. In the table, each cell
indicates the count of observation $n_{ij}$ corresponding to the $i$-th
row and $j$-th column.

|     |       |          | $Y$      |     |          |     |
|-----|-------|----------|----------|-----|----------|-----|
|     |       | $y_1$    | $y_2$    | ... | $y_J$    |     |
|     | $x_1$ | $n_{11}$ | $n_{12}$ | ... | $n_{1J}$ |     |
|     | $x_2$ | $n_{21}$ | $n_{22}$ | ... | $n_{2J}$ |     |
| $X$ | ...   | ...      | ...      | ... | ...      |     |
|     | $x_I$ | $n_{I1}$ | $n_{I2}$ | ... | $n_{3J}$ |     |
:::

Drawing on the `cl.order` data, we can cross-tabulate the frequencies of
`ORDER` by `SUBORDTYPE`. These correspond to our observed frequencies
$n_{ij}$.

```{r}
# Cross-tabulate the frequencies for the variables of interest
freqs <- table(cl.order$ORDER, cl.order$SUBORDTYPE)

print(freqs)

```

The expected frequencies $m_{ij}$ are calculated by

$$
m_{ij} = \frac{i\textrm{th row sum} \times j \textrm{th column sum}}{\textrm{number of observations}}.
$$ {#eq-exp-freq}

The expected frequencies for our combination of variables is shown
below. In which cells can you see the greatest deviations between
observed and expected frequencies?

```{r, echo = TRUE}
#| code-fold: true
#| code-summary: "Show the code"

# Compute expected frequencies

## Calculate row totals
row_totals <- rowSums(freqs)

## Calculate column totals
col_totals <- colSums(freqs)

## Total number of observations
total_obs <- sum(freqs)

## Calculate expected frequencies
expected_table <- outer(row_totals, col_totals) / total_obs

expected_table
```

The $\chi^2$-test now offers a convenient way of quantifying the
differences between the two tables above. Given $n$ observations and $k$
degrees of freedom ($df$)[^chi_square_test-1], the $\chi^2$-statistic
measures how much the observed frequencies **deviate** from the expected
frequencies **for each cell** in a contingency table [cf.
@heumann_introduction_2022: 249-251].

[^chi_square_test-1]: The degrees of freedom are calculated by
    $(\textrm{number of rows} -1) \times (\textrm{number of columns} - 1)$.
    
    

$$
\text{chi-squared =}\frac{(observed - expected)^2}{expected}
$$ {#eq-chisq-simple}


::: {.callout-note collapse="false" title="Mathematical details: Formal definition of the chi-square test"}
The joint deviations make up the final $\chi^2$-score, which is defined
as

$$
\chi^2 = \sum_{i=1}^{I}\sum_{i=j}^{J}{\frac{(n_{ij} - m_{ij})^2}{m_{ij}}}
$$ {#eq-chisq}

for $i = 1, ..., I$ and $j = 1, ..., J$.

:::

### Assumptions

Note, however, that this test comes with certain **statistical
assumptions**. Violations of these assumptions decrease the validity of
the result and could, therefore, lead to wrong conclusions about
relationships in the data. In this case, other tests should be
consulted.

::: callout-important
### Assumptions of the chi-squared test

1.  All observations are independent of each other.
2.  80% of the expected frequencies are $\geq$ 5.
3.  All observed frequencies are $\geq$ 1.

If assumptions 2 and 3 are violated, it is recommended to use a more
robust test such as the Fisher's Exact Test (see `?fisher.test()` for
details) or the log-likelihood test ($G$-test).

In case of dependent observations (e.g., multiple measurements per
participant), the default approach is to fit a multilevel model that can
control for grouping factors (see mixed-effects regression in @sec-mer.)
:::

### Implementation in R

In R, conducting this test is a simple one-liner:

```{r}
freqs_test <- chisq.test(freqs)

print(freqs_test)
```

The test object `freqs_test` also stores the expected frequencies, which
we can also access. They appear to be all right:

```{r}
# Expected frequencies
freqs_test$expected
```

